# Техническое задание: Админ-панель программы лояльности

## 1. Общие требования

### 1.1. Технологический стек
- **Frontend Framework**: React (версия 18+)
- **UI библиотека**: Ant Design (antd) версия 5.x
- **State Management**: React Query / SWR (для работы с API) + Context API (для глобального состояния)
- **Роутинг**: React Router v6
- **Формы**: Ant Design Form + react-hook-form (опционально)
- **HTTP клиент**: Axios
- **Стилизация**: CSS Modules / Styled Components (для кастомных стилей)
- **TypeScript**

### 1.2. Архитектура приложения
- Модульная структура компонентов
- Разделение на страницы (Pages), компоненты (Components), утилиты (Utils)
- Централизованная обработка ошибок API
- Система аутентификации и авторизации
- Адаптивный дизайн (desktop-first, поддержка планшетов)

### 1.3. Требования к API интеграции
- Все эндпоинты должны быть вынесены в конфигурационный файл
- Использование placeholder-ов для URL (например: `{API_BASE_URL}/loyalty/cards/`)
- Поддержка JWT аутентификации через заголовки
- Обработка ошибок 401 (перенаправление на логин), 403, 404, 500
- Индикаторы загрузки для всех асинхронных операций
- Создание MD файла в Yaak или аналогичного в Postman

---

## 2. Структура данных 

### 2.1. Основные сущности (Возможно изменится)

#### **LoyaltyCard (Карта лояльности)**

```typescript
interface LoyaltyCard {
  id: string; // UUID
  user: {
    id: string;
    phone: string;
    name?: string;
    surname?: string;
    email?: string;
  };
  partner: {
    id: string;
    name: string;
    logo?: string;
  };
  card_number: string;
  points_balance: number;
  status: 'active' | 'inactive' | 'blocked' | 'expired';
  wallet_status: 'not_added' | 'apple_added' | 'google_added' | 'both_added';
  apple_pass_id?: string;
  google_pass_id?: string;
  registered_at: string; // ISO datetime
  activated_at?: string;
  expires_at?: string;
  last_activity_at?: string;
  created_at: string;
  updated_at: string;
}
```

#### **LoyaltyTransaction (Транзакция)**

```typescript
interface LoyaltyTransaction {
  id: string; // UUID
  loyalty_card: {
    id: string;
    card_number: string;
  };
  transaction_type: 'earned' | 'spent' | 'expired' | 'adjusted' | 'refunded';
  points: number; // положительное для начисления, отрицательное для списания
  balance_before: number;
  balance_after: number;
  description?: string;
  order_id?: string; // UUID
  created_by?: {
    id: string;
    phone: string;
  };
  created_at: string;
}
```

#### **LoyaltyCardHistory (История изменений)**

```typescript
interface LoyaltyCardHistory {
  id: string;
  loyalty_card: {
    id: string;
    card_number: string;
  };
  change_type: 'activated' | 'deactivated' | 'blocked' | 'unblocked' | 
               'expired' | 'renewed' | 'status_changed' | 'card_number_changed';
  old_value?: string;
  new_value?: string;
  description?: string;
  changed_by?: {
    id: string;
    phone: string;
  };
  created_at: string;
}
```

#### **PartnerFarCardsIntegration (Настройки FarCards)**

```typescript
interface FarCardsSettings {
  id: string;
  partner_id: string;
  partner_name: string;
  api_key: string; // только для чтения
  is_active: boolean;
  discount_number: number;
  bonus_number: number;
  points_to_kopecks_ratio: number; // decimal
  max_payment_percent: number; // 0-100
  min_order_amount_for_points: number; // decimal
  points_percent: number; // decimal, 0-100
  created_at: string;
  updated_at: string;
}
```

---

## 3. Функциональные требования

### 3.1. Аутентификация и авторизация

#### Страница входа
- Поля: телефон, пароль
- Валидация: обязательные поля, формат телефона
- Обработка ошибок: неверные учетные данные, блокировка аккаунта
- После успешного входа: сохранение токена, перенаправление на главную

#### Защита маршрутов
- Проверка токена при загрузке приложения
- Автоматический редирект на логин при истечении токена
- Middleware для проверки прав доступа к разделам

---

### 3.2. Главная страница (Dashboard)

#### Статистика (карточки с метриками)
1. **Общее количество карт**
   - Всего карт
   - Активных карт
   - Заблокированных карт
   - Истекших карт

2. **Баланс баллов**
   - Общий баланс всех карт
   - Средний баланс на карту
   - Карты с нулевым балансом

3. **Активность**
   - Транзакций за сегодня
   - Транзакций за неделю
   - Транзакций за месяц
   - Начислено баллов за период
   - Списано баллов за период

4. **Интеграции**
   - Карт в Apple Wallet
   - Карт в Google Wallet
   - Карт в обоих кошельках

#### Графики (используя Ant Design Charts или Recharts)
- График транзакций по дням (начисление/списание)
- График регистраций новых карт
- Топ-10 партнеров по количеству карт
- Распределение статусов карт (pie chart)

#### Последние транзакции
- Таблица последних 10 транзакций
- Ссылки на детали карты и транзакции

---

### 3.3. Управление картами лояльности

#### Список карт (главная страница раздела)

**Фильтры:**
- Поиск: номер карты, телефон пользователя, имя пользователя
- Статус: все / активна / неактивна / заблокирована / истекла
- Партнер: выпадающий список всех партнеров
- Статус кошелька: все / не добавлена / Apple / Google / оба
- Диапазон баланса: от/до баллов
- Дата регистрации: от/до
- Последняя активность: от/до

**Таблица:**
Колонки:
- Номер карты (ссылка на детали)
- Пользователь (телефон, имя)
- Партнер (название, логотип)
- Баланс баллов
- Статус (badge с цветом)
- Статус кошелька (иконки Apple/Google)
- Дата регистрации
- Последняя активность
- Действия (кнопка "Подробнее")

**Пагинация:**
- 20/50/100 записей на страницу
- Переход по страницам

**Экспорт:**
- Кнопка "Экспорт в CSV" с примененными фильтрами

#### Детальная страница карты

**Вкладка "Основная информация":**
- Номер карты (с возможностью копирования)
- Пользователь: телефон, имя, фамилия, email
- Партнер: название, логотип, адрес, контакты
- Текущий баланс баллов (крупно, с иконкой)
- Статус карты (badge + возможность изменения)
- Статус кошелька (иконки + информация)
- Даты: регистрации, активации, истечения, последней активности

**Действия:**
- Изменить статус (модальное окно с выбором статуса и комментарием)
- Начислить баллы (модальное окно: количество, описание)
- Списать баллы (модальное окно: количество, описание, проверка баланса)
- Скорректировать баланс (модальное окно: новый баланс, описание)
- Заблокировать/разблокировать карту
- Просмотреть QR-код (модальное окно с QR)
- Экспорт данных карты

**Вкладка "Транзакции":**
- Таблица всех транзакций по карте
- Фильтры: тип транзакции, период, связанный заказ
- Сортировка по дате
- Пагинация
- Детали транзакции: тип, баллы, баланс до/после, описание, дата, создатель

**Вкладка "История изменений":**
- Таблица истории изменений карты
- Колонки: тип изменения, старое/новое значение, описание, дата, кто изменил
- Фильтры по типу изменения и периоду

**Вкладка "Настройки Pass":**
- Информация о данных для Apple/Google Wallet
- Поля: logo_url, цвета (background, foreground, label)
- Кнопка "Обновить pass в кошельках" (если требуется обновление)

---

### 3.4. Управление транзакциями

#### Список транзакций

**Фильтры:**
- Поиск: номер карты, ID транзакции, ID заказа
- Тип транзакции: все / начислено / потрачено / истекло / скорректировано / возвращено
- Партнер: выпадающий список
- Период: от/до
- Диапазон баллов: от/до
- Создатель: поиск по телефону

**Таблица:**
Колонки:
- ID транзакции
- Дата и время
- Номер карты (ссылка)
- Пользователь (телефон)
- Партнер
- Тип (badge с цветом)
- Баллы (зеленый для начисления, красный для списания)
- Баланс до/после
- Описание
- Связанный заказ (ссылка, если есть)
- Создатель (для ручных корректировок)

**Действия:**
- Просмотр деталей (модальное окно)
- Экспорт в CSV

#### Детальная страница транзакции
- Полная информация о транзакции
- Ссылки на карту, пользователя, партнера, заказ
- История изменений (если есть)

---

### 3.5. Настройки FarCards интеграции

#### Страница настроек (для партнера)

**Информационный блок:**
- Название партнера
- Статус интеграции (активна/неактивна)
- API ключ (скрыт по умолчанию, кнопка "Показать/Скрыть")
- Кнопка "Скопировать API ключ"
- Кнопка "Перегенерировать ключ" (с подтверждением)

**Форма настроек:**
- Переключатель "Активна" (is_active)
- Номер скидки (discount_number) — число, >= 0
- Номер бонуса (bonus_number) — число, >= 0
- Коэффициент конвертации (points_to_kopecks_ratio) — decimal, > 0
  - Подсказка: "1.0 = 1 балл = 1 копейка, 0.1 = 1 балл = 10 копеек"
- Максимальный процент оплаты (max_payment_percent) — 0-100
  - Подсказка: "Максимальный процент от суммы чека, который можно оплатить баллами"
- Минимальная сумма заказа для начисления (min_order_amount_for_points) — decimal, >= 0
  - Подсказка: "Минимальная сумма заказа в рублях для начисления баллов"
- Процент начисления баллов (points_percent) — decimal, 0-100
  - Подсказка: "Процент от суммы чека для начисления баллов (например, 5.0 = 5%)"

**Валидация:**
- Все числовые поля с проверкой диапазонов
- Сообщения об ошибках под полями
- Кнопка "Сохранить" активна только при изменениях

**Предупреждения:**
- При перегенерации ключа: модальное окно с предупреждением
- При деактивации: подтверждение

---

### 3.6. Отчеты и аналитика (не обязательно)

#### Страница отчетов

**Доступные отчеты:**

1. **Отчет по картам партнера**
   - Выбор партнера
   - Период
   - Метрики: количество карт, общий баланс, средний баланс, активность
   - Экспорт в CSV/PDF

2. **Отчет по транзакциям**
   - Фильтры: партнер, тип, период
   - Сводная таблица: количество, сумма начислений, сумма списаний, чистое изменение
   - График по дням
   - Экспорт

3. **Отчет по активности пользователей**
   - Топ пользователей по балансу
   - Топ пользователей по количеству транзакций
   - Пользователи без активности (за период)
   - Экспорт

4. **Отчет по интеграциям**
   - Статистика по кошелькам (Apple/Google)
   - Карты, требующие обновления
   - Экспорт

---

### 3.7. Управление пользователями (базовое)

#### Список пользователей (с картами лояльности)
- Поиск по телефону, имени, email
- Фильтр по наличию карт
- Таблица: телефон, имя, email, количество карт, общий баланс
- Ссылка на детали пользователя

#### Детали пользователя
- Основная информация
- Список всех карт пользователя
- Ссылки на детали каждой карты

---

## 4. UI/UX требования

### 4.1. Общий дизайн
- Светлая тема (темная — опционально на будущее)
- Цветовая схема Ant Design по умолчанию
- Консистентные отступы и размеры
- Иконки: Ant Design Icons

### 4.2. Компоненты Ant Design
- **Layout**: Layout, Sider, Header, Content, Footer
- **Navigation**: Menu, Breadcrumb
- **Data Display**: Table, Card, Statistic, Descriptions, Tag, Badge, Timeline
- **Data Entry**: Form, Input, Select, DatePicker, InputNumber, Switch, Button
- **Feedback**: Modal, Message, Notification, Spin, Alert, Drawer
- **Other**: Typography, Space, Divider, Empty, Tooltip, Popconfirm

### 4.3. Состояния интерфейса
- Загрузка: Spin для таблиц, Skeleton для страниц
- Пустые состояния: Empty с описанием
- Ошибки: Alert с описанием и действиями
- Успешные действия: Message/Notification

### 4.4. Адаптивность
- Desktop: полная функциональность
- Планшет: упрощенная навигация, адаптивные таблицы
- Mobile: базовый просмотр (опционально, на первом этапе не требуется)

---

## 5. Технические детали реализации



### 5.1. Обработка ошибок
- Централизованный error handler
- Перехват 401 → редирект на логин
- Перехват 403 → сообщение "Недостаточно прав"
- Перехват 404 → сообщение "Ресурс не найден"
- Перехват 500 → сообщение "Ошибка сервера"
- Валидационные ошибки → показ под полями формы

### 5.2. Форматирование данных
- Даты: формат "DD.MM.YYYY HH:mm" (использовать dayjs или date-fns)
- Числа: разделитель тысяч для баллов (1 000, 10 000)
- Телефоны: формат "+7 (XXX) XXX-XX-XX"
- UUID: показывать сокращенный формат в таблицах (первые 8 символов)

---

## 6. Критерии приемки

### 6.1. Функциональность
- ✅ Все страницы реализованы согласно ТЗ
- ✅ Все фильтры и поиск работают корректно
- ✅ Все формы валидируются
- ✅ Все модальные окна открываются/закрываются
- ✅ Экспорт данных работает
- ✅ Пагинация работает

### 6.2. Производительность
- ✅ Фильтрация выполняется быстро
- ✅ Нет лишних перерисовок компонентов

### 6.3. UX
- ✅ Интуитивная навигация (если использованы какие-то гайдлайны будет супер)
- ✅ Понятные сообщения об ошибках (На русском языке обязательно)
- ✅ Индикаторы загрузки на всех операциях
- ✅ Подтверждения для критических действий

### 6.4. Код
- ✅ Компоненты переиспользуемые
- ✅ Код читаемый и документированный
- ✅ Нет дублирования кода
- ✅ TypeScript типы (если используется)

## 7. Дополнительные требования

### 7.1. Безопасность
- Хранение токена в localStorage/sessionStorage (обсудить с backend, предложить свое решение)
- Автоматический logout при истечении токена
- CSRF защита (если требуется backend)

### 7.2. Тестирование
- Рекомендуется: unit-тесты для утилит
- Рекомендуется: интеграционные тесты для критических потоков
- Обязательно: ручное тестирование всех функций

### 7.3. Документация
- README с инструкциями по запуску (можно сгенерировать в ChatGPT)
- Комментарии в коде для сложной логики (очень важно)

---

## 8. Этапы разработки и предполагаемое время выполнения

### Этап 1: Базовая структура (1-2 дня)
- Настройка проекта (Create React App / Vite)
- Установка зависимостей (Ant Design, React Router, Axios)
- Базовая структура папок
- Layout с Sidebar и Header
- Страница логина

### Этап 2: Dashboard (2-3 дня)
- Статистические карточки
- Графики
- Последние транзакции

### Этап 3: Управление картами (4-5 дней)
- Список карт с фильтрами
- Детальная страница карты
- Модальные окна для действий (начисление, списание, изменение статуса)
- Вкладки (транзакции, история, настройки pass)

### Этап 4: Транзакции (2-3 дня)
- Список транзакций
- Фильтры и поиск
- Детальная страница транзакции

### Этап 5: Настройки FarCards (2 дня)
- Страница настроек
- Форма редактирования
- Перегенерация ключа

### Этап 6: Отчеты (2-3 дня)
- Страница отчетов
- Формирование отчетов
- Экспорт

### Этап 7: Полировка и тестирование (2-3 дня)
- Исправление багов
- Улучшение UX
- Оптимизация производительности
- Тестирование

---

## 9. Примечания для разработчика

1. Все эндпоинты API — placeholder-ы. Реальные URL будут предоставлены после интеграции.
2. Структура ответов API должна соответствовать Django REST Framework (стандартные сериализаторы).
3. При работе с формами использовать валидацию на клиенте и сервере.
4. Обратить внимание на производительность таблиц при большом объеме данных (виртуализация, пагинация).
5. Все тексты на русском языке.
6. Приоритет: функциональность > красота (но UI должен быть аккуратным и профессиональным).

---

## 10. Примеры интерфейсов

### Пример структуры страницы списка карт:

┌─────────────────────────────────────────────────────────┐
│ [Логотип] Админ-панель          [Пользователь] [Выход]  │
├──────────┬──────────────────────────────────────────────┤
│          │ Хлебные крошки: Главная > Карты лояльности   │
│          ├──────────────────────────────────────────────┤
│ Меню     │ Фильтры:                                     │
│          │ [Поиск...] [Статус ▼] [Партнер ▼] [Сброс]    │
│ - Дашборд│                                              │
│ - Карты  │ Таблица карт:                                │
│ - Транз. │ ┌──────┬──────────┬──────────┬──────────┐    │
│ - Отчеты │ │Номер │Пользователь│Партнер │Баланс│...│    │
│ - Настр. │ ├──────┼──────────┼──────────┼──────────┤    │
│          │ │12345 │+7999123..│Ресторан │  500  │...│    │
│          │ └──────┴──────────┴──────────┴──────────┘    │
│          │ [< 1 2 3 ... 10 >] [Экспорт CSV]             │
└──────────┴──────────────────────────────────────────────┘